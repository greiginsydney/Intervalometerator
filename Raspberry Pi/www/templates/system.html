{% extends "index.html" %}
{% block content %}

<form name="setLocation" method="post" onsubmit="return userFeedback(this, event)">
	<table>
		<tr>
			<th>System Maintenance</th>
		</tr>
		<tr>
			<td class="noborder">
				<div class="alignleft"><label for="newName">Location name:</label></div>
				<div class="alignright">
					<input name="newName" id="newName" type="text" value="{{ locationName }}" oninput="newText(this.id)">
				</div>
			</td>
		</tr>
		<tr>	
			<td class="noborder">
				<button name="submitLocation" id="submitLocation" type="submit" class="hwbutton">Submit</button>
			</td>
		</tr>
	</table>
</form>

<form name="setThumbsCount" method="post" onsubmit="return userFeedback(this, event)">
	<table>
		<tr>
			<td class="noborder">
				<div class="alignleft">Thumbnail count:</div>
				<div class="alignright">
					<select name="thumbsCount" id="thumbsCount" title="How many thumbnails to show" onchange="newThumbsCount(this.id)">
						{% for count in ['24','48','96','144'] %}
							<option value="{{count}}"{% if count == piThumbCount %} SELECTED{% endif %}>{{count}}</option>
						{% endfor %}
					</select>
				</div>
			</td>
		</tr>
		<tr>	
			<td class="noborder">
				<button name="submitThumbsCount" id="submitThumbsCount" type="submit" class="hwbutton">Submit</button>
			</td>
		</tr>
	</table>
</form>

<table>
	<tr>
		<td>
			<div class="alignleft">Pi model:</div>
			<div class="alignright">{{ piModel }}</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class="alignleft">Pi Linux version:</div>
			<div class="alignright">{{ piLinuxVer }}</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class="alignleft">Pi hostname:</div>
			<div class="alignright">{{ piHostname }}</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class="alignleft">Pi available storage:</div>
			<div class="alignright">{{ piSpaceFree }}</div>
		</td>
	</tr>
	<tr>
		<td>
			<div class="alignleft">Pi uptime:</div>
			<div class="alignright">{{ piUptime }}</div>
		</td>
	</tr>
</table>


<form name="PiEnable" method="post" onsubmit="return userFeedback(this, event)">
	<table>
		<tr>
			<td class="noborder">
				<div class="alignleft">Pi on at (hour):</div>
				<div class="alignright">
					<select name="wakePiTime" id="wakePiTime" title="The hour of the day at which the Pi turns on" onchange="newSelected(this.id)">
						<option class="hidden" disabled selected> -- choose -- </option>
						{% for hour in ['25', '00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23'] %}
							<option value="{{ hour }}"{{ ' SELECTED' if hour == wakePiTime }}>{{ 'Always On' if hour == '25' else hour }}</option>
						{% endfor %}
					</select>
				</div>
			</td>
		</tr>
		<tr id="piMinutes">
			<td class="noborder">
				<div class="alignleft">Pi on for (minutes):</div>
				<div class="alignright">
					<select name="wakePiDuration" id="wakePiDuration" title="How long the Pi will run for each day" onchange="newSelected(this.id)">
						<option class="hidden" disabled selected> -- choose -- </option>
						{% for window in ['05','10','15','20','30','60'] %}
							<option value="{{window}}"{{ ' SELECTED' if window == wakePiDuration }}>{{window}}</option>"
						{% endfor %}
					</select>
				</div>
			</td>
		</tr>
		<tr>
			<td class="noborder">
				<button name="wakePi" id="submitWakePi" type="submit" class="hwbutton" value="wakePi">Submit</button>
			</td>
		</tr>
	</table>
</form>

<form name="sendTime" method="post" onsubmit="userFeedback(this, event); sendTimeToServer()">
	<table>
		<tr>
			<td>
				<div class="alignleft">Arduino date/time:</div>
				<div class="alignright">{{ arduinoDate }} {{ arduinoTime }}</div>
			</td>
		</tr>
		<tr>
			<td>
				<div class="alignleft">Pi date/time:</div>
				<div class="alignright">{{ piDateTime }}</div>
			</td>
		</tr>
		<tr>
			<td>
				<div class="alignleft">Camera date/time:</div>
				<div class="alignright">{{ cameraDateTime }}</div>
			</td>
		</tr>
		<tr>
			<td class="noborder">
				<div class="alignleft">Current PC date/time is</div>
				<div class="alignright" id="now"></div>
			</td>
		</tr>
		<tr>
			<td class="noborder">
				<div class="alignleft"><label for="setArduinoTime">Set Arduino date/time:</label></div>
				<div class="alignright">
					<label class="loginChkbox">
						<input type="checkbox" id="setArduinoTime" name="setArduinoTime" onchange="newSetTimeSelected(this.id)"/>
						<span class="rememberme"></span>
					</label>
				</div>
			</td>
		</tr>
		<tr>
			<td class="noborder">
				<div class="alignleft{% if piNtp == True %} grey-out tooltip{% endif %}">
					<label for="setPiTime">Set Pi date/time:</label>
					{% if piNtp == True %}<span class="tooltiptext">The Pi is sync'd to NTP</span>{% endif %}
				</div>
				<div class="alignright">
					<label class="loginChkbox">
						<input type="checkbox" id="setPiTime" name="setPiTime" onchange="newSetTimeSelected(this.id)"{% if piNtp == True %} DISABLED{% endif %}/>
						<span class="rememberme"></span>
					</label>
				</div>
			</td>
		</tr>
		<tr>
			<td class="noborder">
				<div class="alignleft"><label for="setCameraTime">Set camera date/time:</label></div>
				<div class="alignright">
					<label class="loginChkbox">
						<input type="checkbox" id="setCameraTime" name="setCameraTime" onchange="newSetTimeSelected(this.id)"/>
						<span class="rememberme"></span>
					</label>
				</div>
			</td>
		</tr>
		<tr>
			<td class="noborder">
				<button name="SyncSystem" type="submit" class="hwbutton" id="setDateTimeButton" value="SetDateTime">Set date &amp; time</button>
			</td>
		</tr>
	</table>
</form>

<form name="reboot" method="post" onsubmit="return userFeedback(this, event)">
	<table>
		<tr>
			<td class="noborder">
				<div class="alignleft"><label for="rebootString">Reboot Arduino?</label></div>
				<div class="alignright">(Enter "{{rebootSafeWord}}")</div>
				<div class="alignright">
					<input name="rebootString" id="rebootString" type="text" value="" oninput="newRebootText(this.id)">
				</div>
			</td>
		</tr>
		<tr>
			<td class="noborder">
				{% if wakePiTime == '25' %}
				<p>If you request a reboot, the Arduino first shuts down the Pi, reboots itself, then restarts the Pi.</p>
				{% else %}
				<p>If you request a reboot, the Arduino first shuts down the Pi, reboots itself, then restarts the Pi. The Pi will then run for a further {{wakePiDuration}} minutes.</p>
				{% endif %}
			</td>
		</tr>
		<tr>
			<td class="noborder">
				<button name="Reboot" id="submitReboot" type="submit" class="hwbutton" value="Reboot">Reboot</button>
			</td>
		</tr>
	</table>
</form>

<table class="noborder">
	<tr>
		<td class="noborder">
			<div class="alignright small">version: {{ intvlm8rVersion }}</div>
		</td>
	</tr>
</table>
<script> 

var SelectionByte = 0;
var SelectionBits = new Array();
SelectionBits["wakePiTime"]     = 1;
SelectionBits["wakePiDuration"] = 2;

var SetTimeSelectionByte = 0;
var SetTimeSelectionBits = new Array();
SetTimeSelectionBits["setArduinoTime"]     = 1;
SetTimeSelectionBits["setPiTime"] = 2;
SetTimeSelectionBits["setCameraTime"] = 4;

// This drives the default display on load:
document.getElementById("submitLocation").disabled = true;
document.getElementById("submitThumbsCount").disabled = true;
document.getElementById("submitWakePi").disabled = true;
document.getElementById("setDateTimeButton").disabled = true;
document.getElementById("submitReboot").disabled = true;

// This reveals or suppresses the "Pi on for (minutes)" row if piHour = "Always On"
var piHour = document.getElementById("wakePiTime");
var piMinutes = document.getElementById("piMinutes");
piMinutes.style.display = (piHour.value == "25") ? "none":"";

var short_month = [ "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" ];

function update_time()
{
	var refresh=1000; // Refresh rate in milliseconds
	newtime=setTimeout('sendTimeToServer()', refresh);
}

function sendTimeToServer()
{
	var today = new Date();
	//This is what we send to the Pi & Arduino:
	var date = today.getFullYear() + ('0' + (today.getMonth()+1)).slice(-2) + ('0' + (today.getDate())).slice(-2)
	var time = ('0' + (today.getHours())).slice(-2) + ('0' + (today.getMinutes())).slice(-2) + ('0' + (today.getSeconds())).slice(-2);
	var dateTime = date + time;
	document.forms["sendTime"]["SyncSystem"].value = dateTime;
	
	//This is what we display on-screen:
	var displayedDateTime = today.getFullYear() + ' ' + short_month[today.getMonth()] + ' ' + ('0' + (today.getDate())).slice(-2)
	displayedDateTime += ' ' + ('0' + (today.getHours())).slice(-2) + ':' + ('0' + (today.getMinutes())).slice(-2) + ':' + ('0' + (today.getSeconds())).slice(-2);
	document.getElementById("now").innerHTML = displayedDateTime;

	update_time();
	}

sendTimeToServer();

function newText(id)
{
	var option = document.getElementById(id);
	var button = document.getElementById("submitLocation");
	if (option.defaultValue != option.value)
	{
		button.disabled  = false;
	}
	else
	{
		button.disabled  = true;
	}
}

function newThumbsCount(id)
{
	var option = document.getElementById(id);
	if (!option.options[option.selectedIndex].defaultSelected)
	{
		document.getElementById("submitThumbsCount").disabled  = false;
	}
	else
	{
		document.getElementById("submitThumbsCount").disabled  = true;
	}
}

function newSelected(id)
{
	var option = document.getElementById(id);
	// Reveal/hide fields as appropriate:
	piMinutes.style.display = (piHour.value == "25") ? "none":"";

	if (!option.options[option.selectedIndex].defaultSelected)
	{
		SelectionByte = SelectionByte | SelectionBits[id]; // Or turns the bit on
	}
	else
	{
		SelectionByte = SelectionByte ^ SelectionBits[id]; //XOR turns it off
	}
	lightButtons();
}

function newSetTimeSelected(id)
{
	var option = document.getElementById(id);

	if (option.checked == true)
	{
		SetTimeSelectionByte = SetTimeSelectionByte | SetTimeSelectionBits[id]; // Or turns the bit on
	}
	else
	{
		SetTimeSelectionByte = SetTimeSelectionByte ^ SetTimeSelectionBits[id]; //XOR turns it off
	}
	lightSetTimeButton();
}

function newRebootText(id)
{
	var option = document.getElementById(id);
	var button = document.getElementById("submitReboot");
	if ("{{rebootSafeWord}}" == option.value)
	{
		button.disabled  = false;
	}
	else
	{
		button.disabled  = true;
	}
}

function lightButtons()
{
	if (SelectionByte == 0)
	{
		document.getElementById("submitWakePi").disabled  = true;
	}
	else
	{
		document.getElementById("submitWakePi").disabled  = false;
	}
}

function lightSetTimeButton()
{
	if (SetTimeSelectionByte == 0)
	{
		document.getElementById("setDateTimeButton").disabled  = true;
	}
	else
	{
		document.getElementById("setDateTimeButton").disabled  = false;
	}
}

</script>

{% endblock %}
